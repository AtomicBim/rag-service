version: '3.8'

services:
  # Бэкенд-сервис, который ходит в интернет через VPN
  rag-bot:
    build: ./rag-bot
    container_name: rag_bot
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Прокси для OpenAI
      - HTTPS_PROXY=socks5://172.17.0.1:10808
      - HTTP_PROXY=socks5://172.17.0.1:10808
      # Исключения для внутренних IP, которые не должны ходить через прокси
      - NO_PROXY=localhost,127.0.0.1,rag-chat,rag-embedding
      - PYTHONUNBUFFERED=1
    volumes:
      - ./rag-bot/.env:/app/.env:ro

  # НОВЫЙ сервис для создания эмбеддингов через OpenAI
  rag-embedding:
    build: ./rag-embedding
    container_name: rag_embedding
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # Прокси для OpenAI
      - HTTPS_PROXY=socks5://172.17.0.1:10808
      - HTTP_PROXY=socks5://172.17.0.1:10808
      - NO_PROXY=localhost,127.0.0.1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./rag-bot/.env:/app/.env:ro # Используем тот же .env для ключа

  # Сервис для индексации документов
  rag-indexer:
    build: ./rag-indexer
    container_name: rag_indexer
    restart: "no"
    environment:
      - QDRANT_HOST=192.168.42.188
      - EMBEDDING_SERVICE_URL=http://rag-embedding:8001/create_embedding
    volumes:
      - ./rag-source:/app/rag-source:ro
    depends_on:
      - rag-embedding

  # Фронтенд-сервис с Gradio UI
  rag-chat:
    build: ./rag-chat
    container_name: rag_chat
    restart: unless-stopped
    ports:
      - "7860:7860"
    environment:
      # Исключения для Qdrant и внутренних сервисов
      - NO_PROXY=192.168.42.188,rag-bot,rag-embedding
      - PYTHONUNBUFFERED=1
          # Гарантирует, что rag-bot и rag-embedding запустятся первыми    depends_on:
      - rag-bot
      - rag-embedding
