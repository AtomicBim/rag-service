services:
  # Бэкенд-сервис, который ходит в интернет через VPN
  rag-bot:
    build: ./rag-bot
    container_name: rag_bot
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Прокси для OpenAI
      - HTTPS_PROXY=socks5://172.17.0.1:10808
      - HTTP_PROXY=socks5://172.17.0.1:10808
      # Исключения для внутренних IP, которые не должны ходить через прокси
      - NO_PROXY=localhost,127.0.0.1,rag-chat,rag-embedding
      - PYTHONUNBUFFERED=1
    volumes:
      - ./rag-bot/.env:/app/.env:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # НОВЫЙ сервис для создания эмбеддингов через OpenAI
  rag-embedding:
    build: ./rag-embedding
    container_name: rag_embedding
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      # Прокси для OpenAI
      - HTTPS_PROXY=socks5://172.17.0.1:10808
      - HTTP_PROXY=socks5://172.17.0.1:10808
      - NO_PROXY=localhost,127.0.0.1
      - PYTHONUNBUFFERED=1
    volumes:
      - ./rag-bot/.env:/app/.env:ro # Используем тот же .env для ключа
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Сервис для индексации документов
  rag-indexer:
    build: ./rag-indexer
    container_name: rag_indexer
    restart: "no"
    environment:
      - QDRANT_HOST=${QDRANT_HOST:-192.168.42.188}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - EMBEDDING_SERVICE_URL=http://rag-embedding:8001/create_embedding
    volumes:
      - ./rag-source:/app/rag-source:ro
    depends_on:
      rag-embedding:
        condition: service_healthy

  # Фронтенд-сервис с Gradio UI
  rag-chat:
    build: ./rag-chat
    container_name: rag_chat
    restart: unless-stopped
    ports:
      - "7860:7860"
    environment:
      # Исключения для Qdrant и внутренних сервисов
      - NO_PROXY=${QDRANT_HOST:-192.168.42.188},rag-bot,rag-embedding
      - QDRANT_HOST=${QDRANT_HOST:-192.168.42.188}
      - QDRANT_PORT=${QDRANT_PORT:-6333}
      - COLLECTION_NAME=${COLLECTION_NAME:-internal_regulations_v2}
      - PYTHONUNBUFFERED=1
    depends_on:
      rag-bot:
        condition: service_healthy
      rag-embedding:
        condition: service_healthy
